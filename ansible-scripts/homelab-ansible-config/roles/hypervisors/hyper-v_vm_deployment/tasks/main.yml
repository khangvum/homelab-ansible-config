---
- name: Hyper-V Parent Directory Creation If Not Exists
  ansible.windows.win_file:
    path: "{{ hyper_v_parent_dir }}"
    state: directory

- name: VM Subdirectory Creation If Not Exists
  ansible.windows.win_file:
    path: "{{ hyper_v_parent_dir }}\\{{ item.name }}"
    state: directory
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name

- name: ISO File Copy
  ansible.windows.win_copy:
    src: "{{ item.iso_source }}"
    dest: "{{ hyper_v_parent_dir }}\\{{ item.name }}\\{{ item.iso_destination }}"
    force: false
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name

- name: VM Creation
  ansible.windows.win_powershell:
    script: |
      $changed = $false
      $state = "{{ item.state }}".ToLower()
      $existingVM = Get-VM -Name "{{ item.name }}" -ErrorAction SilentlyContinue

      if ($state -eq "present") {
        $vmName = "{{ item.name }}"
        $vmPath = "{{ hyper_v_parent_dir }}\$vmName"
        $vmDisk = "$vmPath\$vmName.vhdx"
        $vmISO  = "$vmPath\{{ item.iso_destination }}"
        $enableTPM = "{{ item.tpm }}".ToLower()

        # If the VM does not exist, create it
        if (-not $existingVM) {
          New-VM -Name $vmName -MemoryStartupBytes {{ item.memory }}GB -BootDevice CD -NoVHD  -Path $vmPath -Generation {{ item.generation }}

          # Remove the default network adapter
          Remove-VMNetworkAdapter -VMName $vmName -Name "Network Adapter"

          # Attach all switches from the list
          $allSwitches = @(
            {% for sw in hostvars[item.host].v_switches %}
              @{ name = '{{ sw.name }}'; adapter = '{{ sw.adapter }}' }
            {% endfor %}
          )
          foreach ($switch in $allSwitches) {
            Add-VMNetworkAdapter -VMName $vmName -SwitchName $switch.name -Name $switch.adapter
          }

          # Disable dynamic memory
          Set-VMMemory -VMName $vmName -DynamicMemoryEnabled $false

          # Enable TPM if specified
          if ($enableTPM -eq "true") {
            Set-VMKeyProtector -VMName $vmName -NewLocalKeyProtector
            Enable-VMTPM -VMName $vmName
            $changed = $true
          }

          # Use an existing VHD if available
          if (Test-Path $vmDisk) {
            Add-VMHardDiskDrive -VMName $vmName -Path $vmDisk
          } 
          # Otherwise, create a new VHD
          else {
            New-VHD -Path $vmDisk -SizeBytes {{ item.storage }}GB -Dynamic
            Add-VMHardDiskDrive -VMName $vmName -Path $vmDisk
          } 

          # Attach the ISO file if available
          if (Test-Path $vmISO) {
            Set-VMDvdDrive -VMName $vmName -Path $vmISO
          }

          # Set the CPU
          Set-VMProcessor -VMName $vmName -Count {{ item.cpu }}

          # Set secure boot template
          Set-VMFirmware -VMName $vmName -SecureBootTemplate "{{ item.secure_boot_template }}".replace(' ', '')

          $changed = $true
        }
        # If the VM already exists, update the specs
        else {
          $wasRunning = $false
          $needsShutdown = $false
          
          # Check if any changes require VM shutdown
          if ($existingVM.ProcessorCount -ne {{ item.cpu }}) {
            $needsShutdown = $true
          }
          
          $currentTPM = (Get-VMSecurity $vmName).TPMEnabled.ToString().ToLower()
          if (($enableTPM -eq "true" -and $currentTPM -eq "false") -or ($enableTPM -eq "false" -and $currentTPM -eq "true")) {
            $needsShutdown = $true
          }
          
          $currentVHD = Get-VMHardDiskDrive -VMName $vmName
          if ($currentVHD.Path -ne $vmDisk) {
            $needsShutdown = $true
          }
          
          $currentSwitches = (Get-VMNetworkAdapter -VMName $vmName).SwitchName
          $allSwitches = @(
            {% for sw in hostvars[item.host].v_switches %}
              @{ name = '{{ sw.name }}'; adapter = '{{ sw.adapter }}' }
            {% endfor %}
          )
          foreach ($switch in $allSwitches) {
            if ($currentSwitches -notcontains $switch.name) {
              $needsShutdown = $true
              break
            }
          }
          
          if ((Get-VMFirmware -VMName $vmName).SecureBootTemplate -ne "{{ item.secure_boot_template }}".replace(' ', '')) {
            $needsShutdown = $true
          }
          
          # Shutdown VM if needed
          if ($needsShutdown -and $existingVM.State -eq "Running") {
            Write-Host "Stopping $vmName for configuration changes..."
            Stop-VM -Name $vmName -Force
            $wasRunning = $true
          }

          # Update the CPU
          if ($existingVM.ProcessorCount -ne {{ item.cpu }}) {
            Set-VMProcessor -VMName $vmName -Count {{ item.cpu }}
            $changed = $true
          }

          # Update the memory (can be done while running)
          if (((Get-VMMemory -VMName $vmName).Startup / 1GB) -ne {{ item.memory }}) {
            Set-VMMemory -VMName $vmName -StartupBytes {{ item.memory }}GB -DynamicMemoryEnabled $false
            $changed = $true
          }

          # Enable TPM if specified
          if ($enableTPM -eq "true" -and $currentTPM -eq "false") {
            Set-VMKeyProtector -VMName $vmName -NewLocalKeyProtector
            Enable-VMTPM -VMName $vmName
            $changed = $true
          }
          elseif ($enableTPM -eq "false" -and $currentTPM -eq "true") {
            Disable-VMTPM -VMName $vmName
            $changed = $true
          }

          # Update the VHD path
          if ($currentVHD.Path -ne $vmDisk) {
            Remove-VMHardDiskDrive -VMName $vmName -ControllerType $currentVHD.ControllerType -ControllerNumber $currentVHD.ControllerNumber -ControllerLocation $currentVHD.ControllerLocation

            # Use an existing VHD if available
            if (Test-Path $vmDisk) {
              Add-VMHardDiskDrive -VMName $vmName -Path $vmDisk
            } 
            # Otherwise, create a new VHD
            else {
              New-VHD -Path $vmDisk -SizeBytes {{ item.storage }}GB -Dynamic
              Add-VMHardDiskDrive -VMName $vmName -Path $vmDisk
            }

            $changed = $true
          }

          # Update the vSwitch
          foreach ($switch in $allSwitches) {
            # If the VM adapter does not exist, create it
            $vmAdapter = Get-VMNetworkAdapter -VMName $vmName | Where-Object { $_.Name -eq $switch.adapter }
            if (-not $vmAdapter) {
              Add-VMNetworkAdapter -VMName $vmName -SwitchName $switch.name -Name $switch.adapter
              $changed = $true
            }
            # Else if the VM adapter exists, but not connected to the correct switch, reconnect it
            elseif ($currentSwitches -notcontains $switch.name) {
              Connect-VMNetworkAdapter -VMName $vmName -SwitchName $switch.name -Name $switch.adapter
              $changed = $true
            }
          }

          # Update the ISO file (can be done while running)
          $currentDVDDrive = Get-VMDvdDrive -VMName $vmName
          if ($currentDVDDrive -and $currentDVDDrive.Path -ne $vmISO -and (Test-Path $vmISO)) {
            Set-VMDvdDrive -VMName $vmName -Path $vmISO
            $changed = $true
          }

          # Set secure boot template
          if ((Get-VMFirmware -VMName $vmName).SecureBootTemplate -ne "{{ item.secure_boot_template }}".replace(' ', '')) {
            Set-VMFirmware -VMName $vmName -SecureBootTemplate "{{ item.secure_boot_template }}".replace(' ', '')
            $changed = $true
          }

          # Start the VM if it was running before being stopped
          if ($wasRunning) {
            Write-Host "Starting $vmName..."
            Start-VM -Name $vmName
          }
        }
      }
      elseif ($state -eq "absent") {
        if ($existingVM) {
          # Stop the VM if it is running
          if ($existingVM.State -eq "Running") {
            Stop-VM -Name "{{ item.name }}" -Force
          }

          Remove-VM -Name "{{ item.name }}" -Force
          $changed = $true
        }

        # Remove the VM's files
        Get-ChildItem -Path "{{ hyper_v_parent_dir }}\{{ item.name }}" -Recurse -Force |
        Where-Object { $_.Name -like "*{{ item.name }}*" } |
        ForEach-Object {
          Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
        }
      }
      else {
        Write-Error "Invalid state: $state. Use 'present' or 'absent'."
        $Ansible.Failed = $true
      }

      $Ansible.Changed = $changed
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name

# Reference: https://learn.microsoft.com/en-us/powershell/module/hyper-v/set-vm?view=windowsserver2025-ps#-automaticstartaction
- name: Autostart Configuration
  ansible.windows.win_powershell:
    script: |
      # Use the current system culture (e.g., en-US)
      $culture = Get-Culture

      $vmName = "{{ item.name }}"
      $state = "{{ item.state }}".ToLower()
      $autoStart= $culture.TextInfo.ToTitleCase("{{ item.autostart }}")
      $existingVM = Get-VM -Name $vmName -ErrorAction SilentlyContinue

      $changed = $false
      if ($existingVM -and $state -eq "present") {
        if ($existingVM.AutomaticStartAction.ToString() -ne $autoStart) {
          $validStartActions = @("Nothing", "StartIfRunning", "Start")
          
          if ($autoStart -notin $validStartActions) {
            Write-Error "Invalid autostart value: $autoStart. Use 'Nothing', 'StartIfRunning', or 'Start'."
            $Ansible.Failed = $true
            return
          }

          Set-VM -Name $vmName -AutomaticStartAction $autoStart
          $changed = $true
        }
      }

      $Ansible.Changed = $changed
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name

# Reference: https://learn.microsoft.com/en-us/powershell/module/hyper-v/set-vm?view=windowsserver2025-ps#-automaticstopaction
- name: Autostop Configuration
  ansible.windows.win_powershell:
    script: |
      # Use the current system culture (e.g., en-US)
      $culture = Get-Culture

      $vmName = "{{ item.name }}"
      $state = "{{ item.state }}".ToLower()
      $autoStop= $culture.TextInfo.ToTitleCase("{{ item.autostop }}")
      $existingVM = Get-VM -Name $vmName -ErrorAction SilentlyContinue

      $changed = $false
      if ($existingVM -and $state -eq "present") {
        if ($existingVM.AutomaticStopAction.ToString() -ne $autoStop) {
          $validStopActions = @("TurnOff", "Save", "Shutdown")
          
          if ($autoStart -notin $validStartActions) {
            Write-Error "Invalid autostart value: $autoStart. Use 'Nothing', 'StartIfRunning', or 'Start'."
            $Ansible.Failed = $true
            return
          }

          if ($existingVM.State -eq "Running") {
            Stop-VM -Name "{{ item.name }}" -Force
          }
          
          Set-VM -Name $vmName -AutomaticStopAction $autoStop
          $changed = $true
        }
      }

      $Ansible.Changed = $changed
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name

- name: VM Power On
  ansible.windows.win_powershell:
    script: |
      $vmName = "{{ item.name }}"
      $power = "{{ item.power }}".ToLower()
      $state = "{{ item.state }}".ToLower()
      $existingVM = Get-VM -Name $vmName -ErrorAction SilentlyContinue

      $changed = $false
      if ($existingVM -and $state -eq "present") {
        if ($power -eq "true" -and ($existingVM.State -eq "Off" -or $existingVM.State -eq "Saved")) {
          Start-VM -Name $vmName
          $changed = $true
        }
        elseif ($power -eq "false" -and $existingVM.State -eq "Running") {
          Stop-VM -Name $vmName -Force
          $changed = $true
        }
      }

      $Ansible.Changed = $changed
  loop: "{{ hyper_v_vm_list }}"
  when: item.host == computer_name