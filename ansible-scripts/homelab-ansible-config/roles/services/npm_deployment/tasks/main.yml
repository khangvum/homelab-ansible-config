---
- name: Linux Variables Load
  ansible.builtin.include_vars:
    file: ../../../variables/os_var/linux_var.yml

- name: Nginx Proxy Manager (npm) Directory Creation
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  loop:
    - "{{ npm_parent_dir }}"
    - "{{ npm_parent_dir }}/data"
    - "{{ npm_parent_dir }}/letsencrypt"

- name: Docker Compose File Creation
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ npm_parent_dir }}/docker-compose.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  register: docker_compose_file

- name: Nginx Proxy Manager (npm) Deployment
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ npm_parent_dir }}"
  when: docker_compose_file.changed

- name: Nginx Proxy Host Configuration
  block:
    # curl -X POST http://{{ VPN_IP_ADDRESS }}:81/api/tokens \
    # -H "Content-Type: application/json" \
    # -d '{
    #   "identity": "{{ EMAIL }}",
    #   "secret": "{{ PASSWORD}}"
    # }'
    - name: npm API Token Retrieval
      ansible.builtin.uri:
        url: "http://{{ hostvars['KVM-VPN'].ansible_host }}:81/api/tokens"
        method: POST
        body_format: json
        body:
          identity: "{{ domain_admin_user }}"
          secret: "{{ domain_admin_password }}"
      register: npm_api_token

    - name: Proxy Host Existence Check
      ansible.builtin.uri:
        url: "http://{{ hostvars['KVM-VPN'].ansible_host }}:81/api/nginx/proxy-hosts"
        method: GET
        headers:
          Authorization: "Bearer {{ npm_api_token.json.token }}"
        status_code: 200
      register: npm_proxy_hosts

    # Documentation: http://{{ VPN_IP_ADDRESS }}:81/api/schema
    #
    # curl -X POST http://192.168.0.133:81/api/nginx/proxy-hosts \
    #   -H "Authorization: Bearer {{ API_TOKEN }}" \
    #   -H "Content-Type: application/json" \
    #   -d '{
    #     "domain_names": ["{{ DOMAIN_NAME }}"],
    #     "forward_scheme": "http",
    #     "forward_host": "{{ VPN_IP_ADDRESS }}",
    #     "forward_port": {{ FORWARD_PORT }},
    #     "caching_enabled": false,
    #     "block_exploits": true,
    #     "allow_websocket_upgrade": true,
    #     "access_list_id": 0,
    #     "certificate_id": 0,
    #     "ssl_forced": false
    #   }'
    - name: npm Proxy Host Setup
      vars:
        current_match: "{{ npm_proxy_hosts.json | selectattr('domain_names', 'contains', item.name + '.' + domain_name) | list }}"
      ansible.builtin.uri:
        # url: "http://{{ hostvars['KVM-VPN'].ansible_host }}:81/api/nginx/proxy-hosts"
        url: http://{{ hostvars['KVM-VPN'].ansible_host }}:81/api/nginx/proxy-hosts{{ '/' + (current_match[0].id | string) if current_match | length > 0 else '' }}
        # method: POST
        method: "{{ 'PUT' if current_match | length > 0 else 'POST' }}"
        headers:
          Authorization: "Bearer {{ npm_api_token.json.token }}"
        body_format: json
        body: |
          {
            "domain_names": ["{{ item.name }}.{{ domain_name }}"],
            "forward_scheme": "{{ item.forward_scheme | default('http') }}",
            "forward_host": "{{ item.forward_host }}",
            "forward_port": {{ item.forward_port }},
            "caching_enabled": false,
            "block_exploits": true,
            "allow_websocket_upgrade": true,
            "access_list_id": 0,
            "certificate_id": 0,
            "ssl_forced": false
          }
        status_code: [200, 201]
      loop: "{{ docker_services }}"
      register: npm_proxy_result

- name: A-record for Tailscale Creation on Windows DNS Server (KVM-DC01)
  delegate_to: KVM-DC01
  vars: # To run on Windows host
    host_key_checking: False
    ansible_shell_type: cmd
    ansible_connection: ssh
    ansible_ssh_retries: 3
    ansible_become_method: runas
  ansible.windows.win_dns_record:
    name: "{{ item.name }}"
    zone: "{{ domain_name }}"
    type: "A"
    value: "{{ hostvars['KVM-VPN'].ansible_host }}"
    state: present
  loop: "{{ docker_services }}"