---
global:
  scrape_interval: 15s
  scrape_timeout: 10s
  evaluation_interval: 15s
alerting:
  alertmanagers:
    - static_configs:
       - targets: []
      scheme: http
      timeout: 10s
      api_version: v2
scrape_configs:
  # Job 1: Prometheus Self-Monitoring
  - job_name: prometheus
    # honor_timestamps: true
    # scrape_interval: 15s
    # scrape_timeout: 10s
    # metrics_path: /metrics
    # scheme: http
    static_configs:
      - targets:
        - localhost:9090
  # Job 2: Linux Monitoring
  - job_name: node_exporter
    static_configs:
      - targets:
{% for host in groups['containers'] %}
        - {{ hostvars[host].ansible_host }}:9100
{% endfor %}
  # Job 3: Windows Monitoring
  - job_name: windows_exporter
    static_configs:
{% for host in groups['all'] %}
{% if host not in groups['containers'] and hostvars[host].v_switches is defined %}
      - targets: [{{ hostvars[host].ansible_host }}:9182]
        labels:
          host_type: "{{ 'Server' if host == 'KVM-SRV01' else 'VM' }}"
{% endif %}
{% endfor %}
  # Job 4: ESXi Monitoring (using SNMP Exporter)
  - job_name: snmp_exporter
    metrics_path: /snmp
    static_configs:
      - targets:
        - {{ hostvars['KVM-SRV02'].ansible_host }}
    params:
      module: [if_mib]
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{ hostvars['KVM-MONITOR'].ansible_host }}:9116
